<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanbar.appV2</title>
<style>
  body { font-family: system-ui, Arial; margin: 12px; }
  h2 { margin-top: 0; }
  label { font-weight: 600; display:block; margin-top:10px; }
  input, select, textarea, button { width:100%; padding:10px; margin-top:5px; font-size:16px; }
  button { cursor:pointer; }
  .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin-bottom:12px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row > button { flex:1; min-width: 160px; }
  img.preview { max-width:100px; border:1px solid #ccc; border-radius:6px; margin:5px; }
  .muted { color:#666; font-size:13px; }
  .ok { color:green; }
  .err { color:red; }
  .item { padding:8px; border:1px solid #eee; border-radius:8px; margin:6px 0; }
  .item b { font-size: 15px; }
</style>
</head>

<body>

<h2>ðŸ“¦ Scanbar.appV2</h2>

<div class="card">
  <label>OpÃ©rateur *</label>
  <select id="operator">
    <option value="">â€” SÃ©lectionner â€”</option>
    <option>Alice</option>
    <option>Bob</option>
    <option>Charlie</option>
  </select>
  <div class="muted">Choisi une seule fois par session</div>
</div>

<div class="card">
  <div class="row" style="align-items:center;">
    <button type="button" onclick="toggleHistory()">ðŸ“œ Scans rÃ©cents</button>
    <span id="historyArrow" style="font-size:18px;">â–¶</span>
  </div>

  <div id="historyPanel" style="display:none; margin-top:10px;">
    <!-- Filtres -->
    <div class="row">
      <input id="filterRef" placeholder="Filtrer par rÃ©fÃ©rence">
      <input id="filterCode" placeholder="Filtrer par code">
    </div>

    <div class="row">
      <button type="button" onclick="loadRecent()">ðŸ”„ Actualiser</button>
      <button type="button" onclick="exportCSV()">â¬‡ Export CSV</button>
    </div>

    <!-- Liste scrollable -->
    <div id="recentList"
         style="margin-top:10px; max-height:260px; overflow-y:auto;">
    </div>
  </div>
</div>

<div class="card">
  <label>Scan EAN / QR</label>
  <input id="scanInput" placeholder="Scanner ici (douchette)" autocomplete="off">
  <div class="row">
    <button type="button" onclick="noEAN()">Produit sans EAN</button>
    <button type="button" onclick="clearScan()">Effacer</button>
  </div>
</div>

<div class="card">
  <label>RÃ©fÃ©rence produit *</label>
  <input id="reference">

  <label>QuantitÃ© *</label>
  <input id="quantity" type="number" min="1">

  <label>Couleur (optionnel)</label>
  <input id="color">

  <label>Commentaire (optionnel)</label>
  <textarea id="comment"></textarea>
</div>

<div class="card">
  <label>Photos (max 3)</label>
  <input type="file" accept="image/*" capture="environment" onchange="addImage(this)">
  <div id="previews"></div>
  <div class="muted">Photos compressÃ©es automatiquement (500Ã—500)</div>
</div>

<div class="card">
  <button id="btnSubmit" type="button" onclick="submitScan()">âœ… Valider le scan</button>
  <div id="status" class="muted" style="margin-top:8px;"></div>
</div>

<script>
/************ CONFIG ************/
const API_URL = "https://script.google.com/macros/s/AKfycbwA7pFaZIr6uN6Gu2i77W5bEnN5An8KhMV4RlpgHrBRKfXy-30BBsJK6zsP78Xxgj4/exec"; // <-- ton URL Apps Script /exec
const API_TOKEN = "PRO_DISCOUNT02"; // <-- doit matcher Code.gs

/************ STATE ************/
let images = [];
let noEanFlag = false;
let editingScanId = null;

const operatorEl = document.getElementById("operator");
operatorEl.value = localStorage.getItem("scanba_operator") || "";
operatorEl.onchange = () => localStorage.setItem("scanba_operator", operatorEl.value);

document.getElementById("scanInput").addEventListener("keydown", e => {
  if (e.key === "Enter") e.preventDefault();
});

/************ SCAN ************/
function noEAN() {
  noEanFlag = true;
  document.getElementById("scanInput").value = "";
  setStatus("Produit sans EAN (code interne gÃ©nÃ©rÃ©)", "ok");
}

function clearScan() {
  noEanFlag = false;
  document.getElementById("scanInput").value = "";
}

/************ IMAGES ************/
function addImage(input) {
  if (!input.files[0]) return;
  if (images.length >= 3) return setStatus("Max 3 photos", "err");

  const file = input.files[0];
  resizeImage(file, 500, data => {
    images.push({ index: images.length + 1, data });
    renderPreviews();
  });

  input.value = "";
}

function resizeImage(file, max, cb) {
  const img = new Image();
  const reader = new FileReader();
  reader.onload = e => {
    img.onload = () => {
      const scale = Math.min(max / img.width, max / img.height, 1);
      const canvas = document.createElement("canvas");
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
      cb(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]); // base64 pur
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function renderPreviews() {
  const div = document.getElementById("previews");
  div.innerHTML = "";
  images.forEach(i => {
    const im = document.createElement("img");
    im.src = "data:image/jpeg;base64," + i.data;
    im.className = "preview";
    div.appendChild(im);
  });
}

/************ HISTORIQUE ************/
function loadRecent() {
  const operator = operatorEl.value.trim();
  if (!operator) return setStatus("SÃ©lectionne l'opÃ©rateur d'abord", "err");

  setStatus("Chargement scans rÃ©centsâ€¦");

  const payload = {
    version: 1,
    token: API_TOKEN,
    action: "LIST_RECENT",
    client: { operator, device: navigator.userAgent },
    limit: 50
  };

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" }, // Ã©viter preflight CORS
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(r => {
    if (!r.ok) throw new Error(r.error || "Erreur");
    recentItemsCache = r.items || [];
applyFilters();
    setStatus("OK", "ok");
  })
  .catch(e => setStatus(e.message, "err"));
}

function renderRecent(items) {
  const div = document.getElementById("recentList");
  if (!items.length) {
    div.innerHTML = "<div class='muted'>Aucun scan rÃ©cent.</div>";
    return;
  }

  div.innerHTML = items.slice(0, 30).map(it => {
    const ts = it.scan_timestamp ? String(it.scan_timestamp) : "";
    const code = it.code_value ? String(it.code_value) : "";
    const ref = it.product_reference ? String(it.product_reference) : "";
    const qty = it.quantity ? String(it.quantity) : "";
    const hasImg = (it.image_1_url_raw || it.image_2_url_raw || it.image_3_url_raw) ? "ðŸ“·" : "";
    return `
      <div class="item">
        <div><b>${ref}</b> Â· QtÃ© ${qty} ${hasImg}</div>
        <div class="muted">${ts} Â· ${code}</div>
        <button type="button" style="margin-top:6px;" onclick='selectRecent(${JSON.stringify(it)})'>Ouvrir</button>
      </div>
    `;
  }).join("");
}

function selectRecent(item) {
  editingScanId = item.scan_id;

  document.getElementById("scanInput").value = item.code_value || "";
  document.getElementById("reference").value = item.product_reference || "";
  document.getElementById("quantity").value = item.quantity || "";
  document.getElementById("color").value = item.color || "";
  document.getElementById("comment").value = item.comment || "";

  images = [];
  noEanFlag = (String(item.code_type || "").toUpperCase() === "INTERNAL");
  renderPreviews();

  document.getElementById("btnSubmit").textContent = "ðŸ’¾ Mettre Ã  jour";
  setStatus("Mode Ã©dition : ajoute photos/infos puis mets Ã  jour", "ok");
  setTimeout(() => document.getElementById("scanInput").focus(), 50);
}

function clearEdit() {
  editingScanId = null;
  document.getElementById("btnSubmit").textContent = "âœ… Valider le scan";
  resetForm();
  setStatus("Mode nouveau scan", "muted");
}

/************ SUBMIT ************/
function submitScan() {
  const operator = operatorEl.value.trim();
  const reference = document.getElementById("reference").value.trim();
  const quantity = Number(document.getElementById("quantity").value);

  if (!operator || !reference || quantity < 1) {
    return setStatus("Champs obligatoires manquants", "err");
  }

  const action = editingScanId ? "UPDATE_SCAN" : "CREATE_SCAN";

  const payload = {
    version: 1,
    token: API_TOKEN,
    action,
    client: { operator, device: navigator.userAgent },
    scan_id: editingScanId || "",
    scan: {
      scan_method: "scanner",
      code_type: noEanFlag ? "INTERNAL" : "",
      code_value: noEanFlag ? "" : document.getElementById("scanInput").value.trim(),
      no_ean: noEanFlag
    },
    product: {
      product_reference: reference,
      quantity,
      color: document.getElementById("color").value.trim(),
      comment: document.getElementById("comment").value.trim()
    },
    images: {
      count: images.length,
      items: images.map(i => ({
        index: i.index,
        filename: `IMG_${i.index}.jpg`,
        mime: "image/jpeg",
        data_base64: i.data
      }))
    }
  };

  setStatus(action === "UPDATE_SCAN" ? "Mise Ã  jourâ€¦" : "Envoiâ€¦");

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(r => {
    if (!r.ok) throw new Error(r.error || "Erreur");

    // AprÃ¨s rÃ©ussite : on revient en mode scan (rafale)
    editingScanId = null;
    document.getElementById("btnSubmit").textContent = "âœ… Valider le scan";
    resetForm();
    setStatus("OK âœ”", "ok");
  })
  .catch(e => setStatus(e.message, "err"));
}

/************ RESET + STATUS ************/
function resetForm() {
  document.getElementById("scanInput").value = "";
  document.getElementById("reference").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("color").value = "";
  document.getElementById("comment").value = "";
  images = [];
  noEanFlag = false;
  renderPreviews();

  // Focus immÃ©diat pour scan en rafale
  setTimeout(() => document.getElementById("scanInput").focus(), 50);
}

function setStatus(msg, cls="muted") {
  const s = document.getElementById("status");
  s.textContent = msg;
  s.className = cls;
}

// Focus au chargement
setTimeout(() => document.getElementById("scanInput").focus(), 50);
</script>
let recentItemsCache = [];
let historyOpen = false;

function toggleHistory() {
  historyOpen = !historyOpen;
  document.getElementById("historyPanel").style.display = historyOpen ? "block" : "none";
  document.getElementById("historyArrow").textContent = historyOpen ? "â–¼" : "â–¶";

  if (historyOpen && !recentItemsCache.length) {
    loadRecent();
  }
}

function applyFilters() {
  const ref = document.getElementById("filterRef").value.toLowerCase();
  const code = document.getElementById("filterCode").value.toLowerCase();

  const filtered = recentItemsCache.filter(it => {
    const r = String(it.product_reference || "").toLowerCase();
    const c = String(it.code_value || "").toLowerCase();
    return (!ref || r.includes(ref)) && (!code || c.includes(code));
  });

  renderRecent(filtered);
}

function exportCSV() {
  if (!recentItemsCache.length) {
    return setStatus("Aucune donnÃ©e Ã  exporter", "err");
  }

  const headers = [
    "scan_timestamp",
    "operator",
    "code_type",
    "code_value",
    "product_reference",
    "quantity",
    "color",
    "comment",
    "image_folder_url"
  ];

  const rows = recentItemsCache.map(it =>
    headers.map(h => `"${String(it[h] || "").replace(/"/g, '""')}"`).join(";")
  );

  const csv = headers.join(";") + "\n" + rows.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "scanbar_export.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</body>
</html>
