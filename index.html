<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Scanbar.appV2</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e6e6e6;
      --text:#111827;
      --muted:#6b7280;

      --blue:#1f5aa6;
      --blueHover:#184b8a;

      --red:#d7262e;
      --redHover:#b91d24;

      --shadow:0 6px 20px rgba(0,0,0,.06);
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .topbar{
      height:6px;
      background: var(--blue);
      border-bottom: 1px solid var(--border);
    }

    .wrap{
      max-width: 980px;
      margin: 10px auto 40px;
      padding: 0 14px;
    }

    /* HEADER : badge √† gauche + logo centr√© */
    .headerBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 0 16px;
      gap: 10px;
    }
    .appBadge{
      background: var(--blue);
      color:#fff;
      font-weight: 900;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
      box-shadow: 0 2px 0 rgba(0,0,0,.08);
      user-select:none;
    }
    .appBadgeGhost{ visibility:hidden; }

    .brandCenter{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .brandCenter img{
      max-height: 62px;
      width:auto;
      display:block;
    }

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      margin:14px 0;
    }
    label{
      display:block;
      font-weight:900;
      margin: 10px 0 6px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    input, select, textarea{
      width:100%;
      font-size:16px;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
    }
    textarea{min-height: 92px; resize: vertical;}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{flex:1 1 240px;}

    /* BUTTONS */
    .btn{
      appearance:none;
      border:none;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight:900;
      cursor:pointer;
      background: var(--blue);
      color:#fff;
      transition: .12s ease-in-out;
      box-shadow: 0 2px 0 rgba(0,0,0,.08);
      user-select:none;
    }
    .btn:hover{ background: var(--blueHover); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btnDanger{ background: var(--red); color:#fff; }
    .btnDanger:hover{ background: var(--redHover); }

    .btnGhost{
      background:#f3f4f6;
      color:#111827;
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btnGhost:hover{ background:#eceff3; }

    /* STATUS + LOADER */
    .status{ margin-top: 10px; font-weight:900; font-size: 14px; }
    .ok{color:#0f766e}
    .err{color:#b91c1c}
    .muted{color:var(--muted)}

    .loadingBar{
      display:none;
      margin-top:10px;
      height:8px;
      border-radius:999px;
      background:#eef2ff;
      overflow:hidden;
      border:1px solid #e5e7eb;
    }
    .loadingBar > div{
      width:40%;
      height:100%;
      border-radius:999px;
      background:var(--blue);
      animation: move 1.1s infinite linear;
    }
    @keyframes move{
      0%{transform:translateX(-120%)}
      100%{transform:translateX(260%)}
    }

    /* HISTORY DRAWER */
    .drawerHead{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .arrow{
      width:38px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:18px;
      cursor:pointer;
      user-select:none;
    }
    #historyPanel{ display:none; margin-top:10px; }
    #recentList{
      margin-top:10px;
      max-height: 320px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
    }
    .item{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .item:last-child{margin-bottom:0}
    .small{font-size:12px;color:var(--muted)}

    /* PHOTO PREVIEWS */
    .previews{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .preview{
      width: 100px;
      height: 100px;
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
      background:#fafafa;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .preview img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .preview .x{
      position:absolute;
      top:6px;
      right:6px;
      width:22px;
      height:22px;
      border-radius:50%;
      border:none;
      cursor:pointer;
      background:rgba(0,0,0,.55);
      color:#fff;
      font-weight:900;
      line-height:22px;
    }

    /* CAMERA PANEL */
    #camPanel{display:none; margin-top:10px;}
    #camVideo{
      width:100%;
      max-height: 360px;
      background:#000;
      border-radius: 12px;
      border:1px solid var(--border);
    }
    .camHint{font-size:12px;color:var(--muted); margin-top:8px;}

    /* EXPRESS banner */
    #expressBanner{
      display:none;
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
    #expressBanner b{ color: var(--red); }

    /* Tiny help row */
    .microRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .pill{
      display:inline-block;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      background:#fff;
      user-select:none;
    }

    @media (max-width:520px){
      .brandCenter img{ max-height: 42px; } /* logo plus petit sur mobile */
      .btn{ width:100%; }
      .row > *{ flex:1 1 100%; }
      .drawerHead{flex-wrap:wrap;}
      .arrow{width:100%; height:42px;}
      .appBadge, .appBadgeGhost{ font-size: 13px; padding: 8px 10px; }
    }
  </style>
</head>

<body>
  <div class="topbar"></div>

  <div class="wrap">

    <!-- HEADER -->
    <div class="headerBar">
      <div class="appBadge">Scanbar.appV2</div>

      <div class="brandCenter">
        <!-- IMPORTANT : logo.png doit √™tre dans le repo, au m√™me niveau que index.html -->
        <img src="logo.png?v=3" alt="promosdiscount">
      </div>

      <div class="appBadge appBadgeGhost">Scanbar.appV2</div>
    </div>

    <!-- OPERATEUR -->
    <div class="card">
      <label>Op√©rateur *</label>

      <div class="row">
        <select id="operator"></select>

        <!-- Gestion op√©rateurs (prot√©g√©e PIN) -->
        <button class="btn" type="button" onclick="addOperator()">‚ûï Ajouter</button>
        <button class="btnGhost" type="button" onclick="removeOperator()">üóë Retirer</button>
      </div>

    <!-- HISTORY -->
    <div class="card">
      <div class="drawerHead">
        <button class="btn" type="button" onclick="toggleHistory()">üìú Scans r√©cents</button>
        <div class="arrow" id="historyArrow" onclick="toggleHistory()">‚ñ∂</div>
        <button class="btnGhost" type="button" onclick="clearEdit()">‚ûï Nouveau scan</button>
      </div>

      <div id="historyPanel">
        <div class="row">
          <input id="filterRef" placeholder="Filtrer par r√©f√©rence" oninput="applyFilters()">
          <input id="filterCode" placeholder="Filtrer par code" oninput="applyFilters()">
        </div>

        <div class="row">
          <button class="btn" type="button" onclick="loadRecent()">üîÑ Actualiser</button>
          <button class="btn" type="button" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>

        <div class="microRow">
          <span class="pill">Astuce : utilise ‚ÄúOuvrir‚Äù pour compl√©ter plus tard (photos / infos)</span>
          <span class="pill">Le bouton ‚ÄúMettre √† jour‚Äù remplace ‚ÄúValider‚Äù en mode √©dition</span>
        </div>

        <div id="recentList" class="muted">Clique ‚ÄúScans r√©cents‚Äù pour charger‚Ä¶</div>
      </div>
    </div>

    <!-- SCAN -->
    <div class="card">
      <label>Scan EAN / QR</label>
      <input id="scanInput" placeholder="Scanner ici (douchette)">

      <div class="row" style="margin-top:10px;">
        <button class="btn" type="button" onclick="toggleCamera()">üì∑ Scanner cam√©ra</button>
        <button class="btnDanger" type="button" onclick="toggleExpress()">‚ö° Mode Express (PIN)</button>
        <button class="btn" type="button" onclick="noEan()">Produit sans EAN</button>
        <button class="btnGhost" type="button" onclick="resetForm()">Effacer</button>
      </div>

      <!-- Banni√®re Express -->
      <div id="expressBanner">
        <b>‚ö° MODE EXPRESS ACTIF</b>
        <div class="hint" style="margin-top:6px;">
          R√©f√©rence auto <b id="expressRefLabel"></b> ¬∑ Quantit√© = 1 ¬∑
          <button class="btnGhost" type="button" style="padding:6px 10px;margin-left:6px;" onclick="disableExpress()">Quitter</button>
        </div>
      </div>

      <!-- CAMERA -->
      <div id="camPanel">
        <video id="camVideo" playsinline></video>
        <div class="row" style="margin-top:10px;">
          <button class="btnGhost" type="button" onclick="stopCamera()">‚èπ Stop cam√©ra</button>
        </div>
        <div class="camHint" id="camHint">
          Autorise la cam√©ra. Si BarcodeDetector n‚Äôest pas dispo, ZXing se charge automatiquement.
        </div>
      </div>

      <div class="hint">Workflow : Scan ‚Üí (Entr√©e) R√©f√©rence ‚Üí (Entr√©e) Quantit√© ‚Üí (Entr√©e) Valider</div>
    </div>

    <!-- PRODUIT -->
    <div class="card">
      <label>R√©f√©rence produit *</label>
      <input id="reference">

      <label>Quantit√© *</label>
      <input id="quantity" type="number" min="1">

      <div class="row">
        <div>
          <label>Poids (optionnel)</label>
          <input id="weight">
        </div>
        <div>
          <label>Emplacement (optionnel)</label>
          <input id="location">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Dimensions (optionnel)</label>
          <input id="dimension">
        </div>
        <div>
          <label>Couleur (optionnel)</label>
          <input id="color">
        </div>
      </div>

      <label>Commentaire (optionnel)</label>
      <textarea id="comment"></textarea>
    </div>

    <!-- PHOTOS -->
    <div class="card">
      <label>Photos (max 3)</label>
      <input id="photoInput" type="file" accept="image/*" capture="environment" multiple>
      <div class="hint">Jusqu‚Äô√† 3 photos. Compression auto (500√ó500 max).</div>
      <div class="previews" id="previews"></div>
    </div>

    <!-- SUBMIT -->
    <div class="card">
      <button id="btnSubmit" class="btnDanger" type="button" onclick="submitScan()">‚úÖ Valider le scan</button>
      <div class="loadingBar" id="loadingBar"><div></div></div>
      <div class="status muted" id="status">Pr√™t.</div>
    </div>

  </div>

<script>
  /******************** CONFIG (CHANGE ONLY THESE 2) ********************/
  const API_URL = "https://script.google.com/macros/s/AKfycbxD7SFyY3P-rnxIfxIYtkkPQrwtoClOh5EROhVe-ectsvteYXeVALp4Vz8SB47-F1Egtw/exec";
  const API_TOKEN = "PRO_DISCOUNT02";
  /************************************************************************/

  /******************** PIN UNIQUE (OPS + EXPRESS) ********************/
  const PIN_2121 = "2121";
  /*********************************************************************/

  const operatorEl = document.getElementById("operator");
  const scanEl = document.getElementById("scanInput");
  const refEl = document.getElementById("reference");
  const qtyEl = document.getElementById("quantity");
  const weightEl = document.getElementById("weight");
  const locationEl = document.getElementById("location");
  const dimEl = document.getElementById("dimension");
  const colorEl = document.getElementById("color");
  const commentEl = document.getElementById("comment");
  const photoEl = document.getElementById("photoInput");
  const previewsEl = document.getElementById("previews");
  const statusEl = document.getElementById("status");
  const loadingBar = document.getElementById("loadingBar");
  const btnSubmit = document.getElementById("btnSubmit");

  const camPanel = document.getElementById("camPanel");
  const camVideo = document.getElementById("camVideo");
  const camHint = document.getElementById("camHint");

  const expressBannerEl = document.getElementById("expressBanner");
  const expressRefLabelEl = document.getElementById("expressRefLabel");

  let images = [];
  let noEanFlag = false;
  let editingScanId = null;

  let recentItemsCache = [];
  let historyOpen = false;

  let lastScanMethod = "scanner"; // scanner | phone | manual

  // Camera
  let camStream = null;
  let camTimer = null;
  let barcodeDetector = null;
  let zxingReader = null;
  let zxingLoaded = false;

  // Anti-double envoi (orf√®vre)
  let lastSubmitSig = "";
  let lastSubmitAt = 0;

  /******************** OPERATEURS (PIN + add/remove) ********************/
  const OP_KEY = "scanbar_operator";
  const OP_LIST_KEY = "scanbar_operator_list";

  const DEFAULT_OPERATORS = ["Anthony","Johan","K√©o","Michael"];

  function getOperators_(){
    try{
      const raw = localStorage.getItem(OP_LIST_KEY);
      if (!raw) return [...DEFAULT_OPERATORS];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr) || !arr.length) return [...DEFAULT_OPERATORS];
      return arr.map(x => String(x || "").trim()).filter(Boolean);
    }catch(_){
      return [...DEFAULT_OPERATORS];
    }
  }

  function setOperators_(arr){
    const clean = arr.map(x => String(x||"").trim()).filter(Boolean);
    localStorage.setItem(OP_LIST_KEY, JSON.stringify(clean));
  }

  function renderOperatorSelect_(){
    const current = localStorage.getItem(OP_KEY) || "";
    const ops = getOperators_();

    operatorEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî S√©lectionner ‚Äî";
    operatorEl.appendChild(opt0);

    ops.forEach(name => {
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      operatorEl.appendChild(o);
    });

    if (current && ops.includes(current)) operatorEl.value = current;
  }

  function pinOk_(){
    const pin = prompt("üîí Code PIN :");
    if (pin === null) return false;
    if (String(pin).trim() !== PIN_2121){
      setStatus("PIN incorrect", "err");
      return false;
    }
    return true;
  }

  function addOperator(){
    if (!pinOk_()) return;
    const name = prompt("Nom du nouvel op√©rateur (ex: Lucas) :");
    if (name === null) return;
    const n = String(name).trim();
    if (!n) return;

    const ops = getOperators_();
    const exists = ops.some(x => x.toLowerCase() === n.toLowerCase());
    if (exists){
      setStatus("Cet op√©rateur existe d√©j√†", "err");
      return;
    }
    ops.push(n);
    setOperators_(ops);
    renderOperatorSelect_();
    operatorEl.value = n;
    localStorage.setItem(OP_KEY, n);
    setStatus("Op√©rateur ajout√© ‚úÖ", "ok");
  }

  function removeOperator(){
    if (!pinOk_()) return;
    const selected = operatorEl.value.trim();
    if (!selected){
      setStatus("S√©lectionne l‚Äôop√©rateur √† retirer", "err");
      return;
    }
    if (!confirm(`Retirer l‚Äôop√©rateur ‚Äú${selected}‚Äù ?`)) return;

    const ops = getOperators_().filter(x => x.toLowerCase() !== selected.toLowerCase());
    if (!ops.length){
      setStatus("Impossible : il faut garder au moins 1 op√©rateur", "err");
      return;
    }
    setOperators_(ops);
    renderOperatorSelect_();

    // si on vient de supprimer l‚Äôop√©rateur actif
    if ((localStorage.getItem(OP_KEY) || "") === selected){
      localStorage.removeItem(OP_KEY);
      operatorEl.value = "";
    }
    setStatus("Op√©rateur retir√© ‚úÖ", "ok");
  }

  operatorEl.addEventListener("change", () => {
    const v = operatorEl.value.trim();
    if (v) localStorage.setItem(OP_KEY, v);
  });
  /*********************************************************************/

  /******************** MODE EXPRESS (PIN + RESET JOURNALIER) ********************/
  const EXPRESS_PIN = PIN_2121;
  const EXPRESS_PREFIX = "ref-";
  const EXPRESS_PAD = 4;
  const EXPRESS_TIMEOUT_MIN = 30;

  const EXP_DATE_KEY = "SCANBAR_EXPRESS_DATE";
  const EXP_SEQ_KEY  = "SCANBAR_EXPRESS_SEQ";

  let expressOn = false;
  let expressSeq = 1;
  let expressLastActivity = 0;

  function todayKey_(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function loadExpressSeq_(){
    const tk = todayKey_();
    const savedDate = localStorage.getItem(EXP_DATE_KEY) || "";
    if (savedDate !== tk){
      localStorage.setItem(EXP_DATE_KEY, tk);
      localStorage.setItem(EXP_SEQ_KEY, "1");
      return 1;
    }
    const n = Number(localStorage.getItem(EXP_SEQ_KEY) || "1");
    return (Number.isFinite(n) && n >= 1) ? n : 1;
  }

  function saveExpressSeq_(n){
    localStorage.setItem(EXP_DATE_KEY, todayKey_());
    localStorage.setItem(EXP_SEQ_KEY, String(n));
  }

  function toggleExpress(){
    if (expressOn) return disableExpress();
    const pin = prompt("üîí Entrer le code PIN pour activer le mode Express :");
    if (pin === null) return;
    if (String(pin).trim() !== EXPRESS_PIN){
      setStatus("PIN incorrect", "err");
      return;
    }
    enableExpress();
  }

  function enableExpress(){
    expressOn = true;
    expressLastActivity = Date.now();

    expressSeq = loadExpressSeq_();
    expressBannerEl.style.display = "block";

    setExpressRef_(expressSeq);
    qtyEl.value = "1";

    setStatus("Mode Express activ√© ‚úÖ", "ok");
    startExpressWatchdog_();
    setTimeout(()=>scanEl.focus(), 50);
  }

  function disableExpress(){
    expressOn = false;
    expressBannerEl.style.display = "none";
    setStatus("Mode Express d√©sactiv√©", "muted");
  }

  function startExpressWatchdog_(){
    if (window.__expTimer) clearInterval(window.__expTimer);
    window.__expTimer = setInterval(() => {
      if (!expressOn) return;
      const mins = (Date.now() - expressLastActivity) / 60000;
      if (mins >= EXPRESS_TIMEOUT_MIN){
        disableExpress();
        setStatus("Mode Express verrouill√© (inactivit√©)", "muted");
        clearInterval(window.__expTimer);
        window.__expTimer = null;
      }
    }, 5000);
  }

  function touchExpress_(){
    if (!expressOn) return;
    expressLastActivity = Date.now();
    const newSeq = loadExpressSeq_();
    if (newSeq !== expressSeq){
      expressSeq = newSeq;
      setExpressRef_(expressSeq);
    }
  }

  function setExpressRef_(n){
    const r = EXPRESS_PREFIX + String(n).padStart(EXPRESS_PAD, "0");
    refEl.value = r;
    expressRefLabelEl.textContent = r;
  }

  function advanceExpress_(){
    expressSeq += 1;
    saveExpressSeq_(expressSeq);
    setExpressRef_(expressSeq);
    qtyEl.value = "1";
  }

  function expressCommentWrap_(existing){
    const ref = (refEl.value || "").trim();
    const base = String(existing || "").trim();
    const tag = `[EXPRESS ${ref}]`;
    if (!base) return tag;
    if (base.startsWith("[EXPRESS")) return base;
    return `${tag} ${base}`;
  }
  /************************************************************************/

  window.addEventListener("load", () => {
    renderOperatorSelect_();
    setTimeout(() => scanEl.focus(), 150);
  });

  // Enter key workflow
  scanEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      lastScanMethod = "scanner";
      refEl.focus();
    }
  });
  refEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); qtyEl.focus(); }
  });
  qtyEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); btnSubmit.focus(); }
  });

  scanEl.addEventListener("input", () => { if (!noEanFlag) lastScanMethod = "scanner"; });

  function setStatus(msg, cls="muted"){
    statusEl.className = "status " + cls;
    statusEl.textContent = msg;
  }
  function setLoading(on){
    loadingBar.style.display = on ? "block" : "none";
    btnSubmit.disabled = !!on;
  }

  // Drawer
  function toggleHistory(){
    historyOpen = !historyOpen;
    document.getElementById("historyPanel").style.display = historyOpen ? "block" : "none";
    document.getElementById("historyArrow").textContent = historyOpen ? "‚ñº" : "‚ñ∂";
    if (historyOpen && !recentItemsCache.length) loadRecent();
  }

  function applyFilters(){
    const ref = (document.getElementById("filterRef").value || "").toLowerCase();
    const code = (document.getElementById("filterCode").value || "").toLowerCase();
    const filtered = recentItemsCache.filter(it => {
      const r = String(it.product_reference || "").toLowerCase();
      const c = String(it.code_value || "").toLowerCase();
      return (!ref || r.includes(ref)) && (!code || c.includes(code));
    });
    renderRecent(filtered);
  }

  function exportCSV(){
    if (!recentItemsCache.length) return setStatus("Aucune donn√©e √† exporter", "err");
    const headers = [
      "scan_timestamp","operator","scan_method","code_type","code_value",
      "product_reference","quantity","weight","location","dimension",
      "color","comment","image_folder_url","image_1_url_raw","image_2_url_raw","image_3_url_raw"
    ];
    const rows = recentItemsCache.map(it => headers.map(h => `"${String(it[h]||"").replace(/"/g,'""')}"`).join(";"));
    const csv = headers.join(";") + "\n" + rows.join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "scanbar_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function noEan(){
    noEanFlag = true;
    lastScanMethod = "manual";
    scanEl.value = "";
    setStatus("Mode sans EAN : un code interne sera g√©n√©r√©", "ok");
    refEl.focus();
  }

  function resetForm(){
    stopCamera();
    scanEl.value = "";
    refEl.value = "";
    qtyEl.value = "";
    weightEl.value = "";
    locationEl.value = "";
    dimEl.value = "";
    colorEl.value = "";
    commentEl.value = "";
    images = [];
    noEanFlag = false;
    lastScanMethod = "scanner";
    editingScanId = null;
    btnSubmit.textContent = "‚úÖ Valider le scan";
    photoEl.value = "";
    renderPreviews();
    setStatus("Pr√™t.", "muted");
    setTimeout(()=>scanEl.focus(), 50);
  }

  function clearEdit(){
    editingScanId = null;
    btnSubmit.textContent = "‚úÖ Valider le scan";
    resetForm();
    setStatus("Mode nouveau scan", "muted");
  }

  photoEl.addEventListener("change", async () => {
    const files = Array.from(photoEl.files || []).slice(0, 3);
    images = [];
    for (let i=0; i<files.length; i++){
      const b64 = await fileToBase64Compressed_(files[i], 500, 0.75);
      images.push({ index: i+1, data_base64: b64.base64, mime: b64.mime });
    }
    renderPreviews();
  });

  function renderPreviews(){
    previewsEl.innerHTML = "";
    if (!images.length) return;

    images.forEach((img, idx) => {
      const div = document.createElement("div");
      div.className = "preview";
      const im = document.createElement("img");
      im.src = `data:${img.mime};base64,${img.data_base64}`;
      const x = document.createElement("button");
      x.className = "x";
      x.textContent = "√ó";
      x.onclick = () => { images.splice(idx,1); renderPreviews(); };
      div.appendChild(im);
      div.appendChild(x);
      previewsEl.appendChild(div);
    });
  }

  function payloadBase(action){
    const scan_method = (images.length ? "phone" : lastScanMethod);
    return {
      version: 1,
      token: API_TOKEN,
      action,
      client: { operator: operatorEl.value.trim(), device: navigator.userAgent },
      scan: {
        scan_method,
        no_ean: !!noEanFlag,
        code_value: (scanEl.value || "").trim()
      },
      product: {
        product_reference: (refEl.value || "").trim(),
        quantity: Number(qtyEl.value || 0),
        weight: (weightEl.value || "").trim(),
        location: (locationEl.value || "").trim(),
        dimension: (dimEl.value || "").trim(),
        color: (colorEl.value || "").trim(),
        comment: (commentEl.value || "").trim()
      },
      images: { items: images }
    };
  }

  async function submitScan(){
    const operator = operatorEl.value.trim();
    if (!operator) return setStatus("S√©lectionne l'op√©rateur", "err");

    if (expressOn) touchExpress_();

    const ref = refEl.value.trim();
    const qty = Number(qtyEl.value || 0);

    if (!ref) return setStatus("R√©f√©rence obligatoire", "err");
    if (!qty || qty < 1) return setStatus("Quantit√© obligatoire (>=1)", "err");

    // Anti double envoi (orf√®vre) : m√™me ref+qty+code en < 2s
    const sig = `${operator}|${scanEl.value.trim()}|${ref}|${qty}|${images.length}|${editingScanId||""}|${expressOn?"E":"N"}`;
    const now = Date.now();
    if (!editingScanId && sig === lastSubmitSig && (now - lastSubmitAt) < 2000){
      setStatus("D√©j√† envoy√© (anti double-clic)", "muted");
      return;
    }
    lastSubmitSig = sig;
    lastSubmitAt = now;

    const action = editingScanId ? "UPDATE_SCAN" : "CREATE_SCAN";

    // Mode express : qty=1 par d√©faut + tag commentaire
    if (expressOn) {
      if (!qtyEl.value || Number(qtyEl.value) < 1) qtyEl.value = "1";
      commentEl.value = expressCommentWrap_(commentEl.value);
      lastScanMethod = "scanner";
    }

    const payload = payloadBase(action);
    if (editingScanId) payload.scan_id = editingScanId;

    setLoading(true);
    setStatus("Envoi en cours‚Ä¶", "muted");

    try{
      const r = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || "Erreur");

      setStatus(editingScanId ? "‚úÖ Mise √† jour OK" : "‚úÖ Scan OK", "ok");

      stopCamera();
      scanEl.value = "";
      weightEl.value = "";
      locationEl.value = "";
      dimEl.value = "";
      colorEl.value = "";
      commentEl.value = "";
      images = [];
      noEanFlag = false;
      lastScanMethod = "scanner";
      editingScanId = null;
      btnSubmit.textContent = "‚úÖ Valider le scan";
      photoEl.value = "";
      renderPreviews();

      if (expressOn) {
        advanceExpress_();
      } else {
        refEl.value = "";
        qtyEl.value = "";
      }

      setTimeout(()=>scanEl.focus(), 120);
      if (historyOpen) loadRecent();

    }catch(e){
      setStatus(String(e.message || e), "err");
    }finally{
      setLoading(false);
    }
  }

  function loadRecent(){
    const operator = operatorEl.value.trim();
    if (!operator) return setStatus("S√©lectionne l'op√©rateur d'abord", "err");

    setStatus("Chargement scans r√©cents‚Ä¶", "muted");

    const payload = {
      version: 1,
      token: API_TOKEN,
      action: "LIST_RECENT",
      client: { operator, device: navigator.userAgent },
      limit: 160
    };

    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(j => {
      if (!j.ok) throw new Error(j.error || "Erreur");
      recentItemsCache = j.items || [];
      applyFilters();
      setStatus("OK", "ok");
    })
    .catch(e => setStatus(e.message, "err"));
  }

  function renderRecent(items){
    const div = document.getElementById("recentList");
    if (!items.length) {
      div.innerHTML = "<div class='muted'>Aucun scan r√©cent.</div>";
      return;
    }

    div.innerHTML = items.slice(0, 80).map(it => {
      const ts = it.scan_timestamp ? String(it.scan_timestamp) : "";
      const code = it.code_value ? String(it.code_value) : "";
      const ref = it.product_reference ? String(it.product_reference) : "";
      const qty = it.quantity ? String(it.quantity) : "";
      const hasImg = (it.image_1_url_raw || it.image_2_url_raw || it.image_3_url_raw) ? "üì∑" : "";
      const m = it.scan_method ? String(it.scan_method) : "";
      return `
        <div class="item">
          <div><b>${escapeHtml_(ref)}</b> ¬∑ Qt√© ${escapeHtml_(qty)} ${hasImg}</div>
          <div class="small">${escapeHtml_(ts)} ¬∑ ${escapeHtml_(code)} ¬∑ ${escapeHtml_(m)}</div>
          <div class="row" style="margin-top:8px;">
            <button class="btn" type="button" onclick='selectRecent(${JSON.stringify(it)})'>Ouvrir</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function selectRecent(item){
    editingScanId = item.scan_id;

    scanEl.value = item.code_value || "";
    refEl.value = item.product_reference || "";
    qtyEl.value = item.quantity || "";
    weightEl.value = item.weight || "";
    locationEl.value = item.location || "";
    dimEl.value = item.dimension || "";
    colorEl.value = item.color || "";
    commentEl.value = item.comment || "";

    images = [];
    noEanFlag = (String(item.code_type || "").toUpperCase() === "INTERNAL");
    lastScanMethod = String(item.scan_method || "scanner").toLowerCase() || "scanner";

    btnSubmit.textContent = "üíæ Mettre √† jour";
    setStatus("Mode √©dition : modifie + ajoute photos si besoin", "ok");

    setTimeout(()=>scanEl.focus(), 50);
  }

  // Camera scan
  async function toggleCamera(){
    if (camStream) return stopCamera();
    camPanel.style.display = "block";
    camHint.textContent = "D√©marrage cam√©ra‚Ä¶";
    try{
      lastScanMethod = "phone";
      camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
      camVideo.srcObject = camStream;
      await camVideo.play();

      if ("BarcodeDetector" in window) {
        try{
          barcodeDetector = new BarcodeDetector({ formats: ["ean_13","ean_8","qr_code","code_128"] });
          camHint.textContent = "Cam√©ra OK ‚Äî d√©tection en cours‚Ä¶";
          startDetectLoop_BarcodeDetector_();
          return;
        } catch(e){
          barcodeDetector = null;
        }
      }

      camHint.textContent = "BarcodeDetector indisponible ‚Äî chargement ZXing‚Ä¶";
      await loadZXing_();
      camHint.textContent = zxingLoaded ? "ZXing charg√© ‚Äî d√©tection en cours‚Ä¶" : "ZXing non charg√© (r√©seau/CDN). Utilise la douchette.";
      if (zxingLoaded) startDetectLoop_ZXing_();

    }catch(e){
      camHint.textContent = "Cam√©ra refus√©e / indisponible. Utilise la douchette.";
      stopCamera();
      setStatus(String(e.message || e), "err");
    }
  }

  function stopCamera(){
    if (camTimer){ clearInterval(camTimer); camTimer = null; }
    if (zxingReader){ try{ zxingReader.reset(); }catch(_){ } }
    barcodeDetector = null;

    if (camStream){
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
    camVideo.srcObject = null;
    camPanel.style.display = "none";
  }

  function startDetectLoop_BarcodeDetector_(){
    if (!barcodeDetector) return;
    if (camTimer) clearInterval(camTimer);

    camTimer = setInterval(async () => {
      try{
        const codes = await barcodeDetector.detect(camVideo);
        if (codes && codes.length){
          const val = String(codes[0].rawValue || "").trim();
          if (val) onDetectedCode_(val);
        }
      }catch(_){}
    }, 250);
  }

  function startDetectLoop_ZXing_(){
    if (!zxingLoaded) return;
    if (camTimer) clearInterval(camTimer);

    try{
      zxingReader = new ZXing.BrowserMultiFormatReader();
      camTimer = setInterval(async () => {
        try{
          const result = await zxingReader.decodeOnceFromVideoElement(camVideo);
          if (result && result.text){
            onDetectedCode_(String(result.text).trim());
          }
        }catch(_){}
      }, 600);
    }catch(_){
      camHint.textContent = "ZXing error. Utilise la douchette.";
    }
  }

  function onDetectedCode_(val){
    stopCamera();
    scanEl.value = val;
    lastScanMethod = "phone";
    setStatus("Code d√©tect√© ‚úÖ", "ok");
    setTimeout(()=>refEl.focus(), 80);
  }

  function loadZXing_(){
    return new Promise((resolve) => {
      if (window.ZXing) { zxingLoaded = true; return resolve(); }
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js";
      s.onload = () => { zxingLoaded = !!window.ZXing; resolve(); };
      s.onerror = () => { zxingLoaded = false; resolve(); };
      document.head.appendChild(s);
    });
  }

  function escapeHtml_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Compression image => max 500px, qualit√© ~0.75
  function fileToBase64Compressed_(file, maxSize=500, quality=0.75){
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          const canvas = document.createElement("canvas");
          let w = img.width, h = img.height;
          const scale = Math.min(1, maxSize / Math.max(w,h));
          w = Math.round(w*scale); h = Math.round(h*scale);
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const mime = "image/jpeg";
          const dataUrl = canvas.toDataURL(mime, quality);
          const base64 = dataUrl.split(",")[1];
          resolve({ base64, mime });
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>

</body>
</html>
