<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanbar.appV2</title>

<style>
  body { font-family: system-ui, Arial; margin: 12px; background:#f7f7f7; }
  h2 { margin: 0 0 10px 0; }
  label { font-weight: 600; display:block; margin-top:10px; }
  input, select, textarea, button {
    width:100%; padding:10px; margin-top:5px; font-size:16px;
    box-sizing:border-box;
  }
  button { cursor:pointer; }
  button[disabled] { opacity:0.5; cursor:not-allowed; }

  .card {
    background:#fff;
    border:1px solid #ddd;
    border-radius:10px;
    padding:12px;
    margin-bottom:12px;
  }

  .row {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .row > * { flex:1; min-width:140px; }

  .muted { color:#666; font-size:13px; }
  .ok { color:#2e7d32; }
  .err { color:#c62828; }

  img.preview {
    max-width:100px;
    border:1px solid #ccc;
    border-radius:6px;
    margin:5px;
  }

  .item {
    padding:8px;
    border:1px solid #eee;
    border-radius:8px;
    margin:6px 0;
  }

  .toast {
    position:fixed;
    bottom:16px;
    left:50%;
    transform:translateX(-50%);
    background:#222;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    opacity:0;
    transition:opacity .2s;
    pointer-events:none;
  }
  .toast.show { opacity:0.95; }
</style>
</head>

<body>

<h2>ðŸ“¦ Scanbar.appV2</h2>

<!-- OPERATEUR -->
<div class="card">
  <label>OpÃ©rateur *</label>
  <select id="operator">
    <option value="">â€” SÃ©lectionner â€”</option>
    <option>Anthony</option>
    <option>Johan</option>
    <option>KÃ©o</option>
    <option>Michael</option>
  </select>
  <div class="muted">Choisi une seule fois par session</div>
</div>

<!-- HISTORIQUE -->
<div class="card">
  <div class="row">
    <button onclick="toggleHistory()">ðŸ“œ Scans rÃ©cents</button>
    <span id="historyArrow">â–¶</span>
    <button onclick="clearEdit()">âž• Nouveau scan</button>
  </div>

  <div id="historyPanel" style="display:none;margin-top:10px;">
    <div class="row">
      <input id="filterRef" placeholder="Filtrer par rÃ©fÃ©rence" oninput="applyFilters()">
      <input id="filterCode" placeholder="Filtrer par code" oninput="applyFilters()">
    </div>

    <div class="row">
      <label><input type="checkbox" id="filterNoPhoto" onchange="applyFilters()"> Sans photo</label>
      <label><input type="checkbox" id="filterToday" onchange="applyFilters()"> Aujourdâ€™hui</label>
    </div>

    <div class="row">
      <button onclick="loadRecent()">ðŸ”„ Actualiser</button>
      <button onclick="exportCSV()">â¬‡ Export CSV</button>
    </div>

    <div id="recentList" style="max-height:260px;overflow-y:auto;margin-top:10px;"></div>
  </div>
</div>

<!-- SCAN -->
<div class="card">
  <label>Scan EAN / QR</label>
  <input id="scanInput" placeholder="Scanner ici (douchette)">
  <div class="row">
    <button onclick="startCameraScan()">ðŸ“· Utiliser appareil photo</button>
    <button onclick="noEAN()">Produit sans EAN</button>
    <button onclick="clearScan()">Effacer</button>
  </div>
</div>

<!-- PRODUIT -->
<div class="card">
  <label>RÃ©fÃ©rence produit *</label>
  <input id="reference">

  <label>QuantitÃ© *</label>
  <input id="quantity" type="number" min="1">

  <label>Poids (optionnel)</label>
  <input id="weight">

  <label>Emplacement (optionnel)</label>
  <input id="location">

  <label>Dimensions (optionnel)</label>
  <input id="dimension">
  
  <label>Couleur (optionnel)</label>
  <input id="color">

  <label>Commentaire (optionnel)</label>
  <textarea id="comment"></textarea>
</div>

<!-- PHOTOS -->
<div class="card">
  <label>Photos (max 3)</label>
  <input type="file" accept="image/*" capture="environment" onchange="addImage(this)">
  <div id="previews"></div>
</div>

<!-- ACTION -->
<div class="card">
  <button onclick="submitScan()">âœ… Valider le scan</button>
  <div id="status" class="muted"></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbwA7pFaZIr6uN6Gu2i77W5bEnN5An8KhMV4RlpgHrBRKfXy-30BBsJK6zsP78Xxgj4/exec";
const API_TOKEN = "PRO_DISCOUNT02";

/* ================= STATE ================= */
let images = [];
let noEanFlag = false;
let editingScanId = null;

let recentItemsCache = [];
let historyOpen = false;

/* ================= UTILS ================= */
const scanEl = document.getElementById("scanInput");
const operatorEl = document.getElementById("operator");

operatorEl.value = localStorage.getItem("scanba_operator") || "";
operatorEl.onchange = () => localStorage.setItem("scanba_operator", operatorEl.value);

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}
function setStatus(m,c="muted"){const s=document.getElementById("status");s.textContent=m;s.className=c;}
function focusScan(){setTimeout(()=>scanEl.focus(),50);}

/* ================= SCAN ================= */
function noEAN(){noEanFlag=true;scanEl.value="";toast("Sans EAN");focusScan();}
function clearScan(){noEanFlag=false;scanEl.value="";focusScan();}

/* ===== CAMERA SCAN ===== */
let camStream=null, detector=null;

async function startCameraScan(){
  if(!("BarcodeDetector"in window)){
    alert("Scan camÃ©ra non supportÃ© sur ce navigateur.\nUtilise la douchette.");
    return;
  }
  detector=new BarcodeDetector({formats:["ean_13","ean_8","qr_code"]});
  const video=document.createElement("video");
  video.setAttribute("playsinline",true);
  video.style.width="100%";

  const box=document.createElement("div");
  box.className="card";
  box.appendChild(video);

  const btn=document.createElement("button");
  btn.textContent="âœ– Fermer la camÃ©ra";
  btn.onclick=()=>stopCamera(box);
  box.appendChild(btn);

  document.body.prepend(box);

  camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=camStream;
  await video.play();

  (function loop(){
    detector.detect(video).then(codes=>{
      if(codes.length){
        scanEl.value=codes[0].rawValue;
        toast("Code dÃ©tectÃ© âœ”");
        stopCamera(box);
        focusScan();
      } else requestAnimationFrame(loop);
    });
  })();
}
function stopCamera(box){
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}
  if(box)box.remove();
}

/* ================= IMAGES ================= */
function addImage(input){
  if(!input.files[0]||images.length>=3)return;
  const r=new FileReader();
  r.onload=e=>{
    images.push({index:images.length+1,data:e.target.result.split(",")[1]});
    renderPreviews();
  };
  r.readAsDataURL(input.files[0]);
  input.value="";
}
function renderPreviews(){
  const d=document.getElementById("previews");d.innerHTML="";
  images.forEach(i=>{
    const im=document.createElement("img");
    im.src="data:image/jpeg;base64,"+i.data;
    im.className="preview";
    d.appendChild(im);
  });
}

/* ================= HISTORY ================= */
function toggleHistory(){
  historyOpen=!historyOpen;
  document.getElementById("historyPanel").style.display=historyOpen?"block":"none";
  document.getElementById("historyArrow").textContent=historyOpen?"â–¼":"â–¶";
  if(historyOpen&&!recentItemsCache.length)loadRecent();
}
function loadRecent(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({
      token:API_TOKEN,
      action:"LIST_RECENT",
      client:{operator:operatorEl.value}
    })
  }).then(r=>r.json()).then(r=>{
    recentItemsCache=r.items||[];
    applyFilters();
  });
}
function applyFilters(){
  const ref=document.getElementById("filterRef").value.toLowerCase();
  const code=document.getElementById("filterCode").value.toLowerCase();
  const noPhoto=document.getElementById("filterNoPhoto").checked;
  const today=document.getElementById("filterToday").checked;

  const now=new Date();
  const res=recentItemsCache.filter(it=>{
    if(ref&&!String(it.product_reference||"").toLowerCase().includes(ref))return false;
    if(code&&!String(it.code_value||"").toLowerCase().includes(code))return false;
    if(noPhoto&&(it.image_1_url_raw||it.image_2_url_raw||it.image_3_url_raw))return false;
    if(today){
      const d=new Date(it.scan_timestamp);
      if(d.toDateString()!==now.toDateString())return false;
    }
    return true;
  });
  renderRecent(res);
}
function renderRecent(items){
  const d=document.getElementById("recentList");
  d.innerHTML=items.map(it=>`
    <div class="item">
      <b>${it.product_reference}</b> Â· QtÃ© ${it.quantity}<br>
      <span class="muted">${it.code_value}</span>
    </div>`).join("");
}
function exportCSV(){
  const h=["scan_timestamp","operator","code_value","product_reference","quantity"];
  const rows=recentItemsCache.map(it=>h.map(k=>`"${it[k]||""}"`).join(";"));
  const csv=h.join(";")+"\n"+rows.join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="scanbar.csv";
  a.click();
}

/* ================= SUBMIT ================= */
function submitScan(){
  if(!operatorEl.value)return toast("Choisis lâ€™opÃ©rateur");
  if(!document.getElementById("reference").value||document.getElementById("quantity").value<1)
    return toast("RÃ©fÃ©rence + quantitÃ© obligatoires");

  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({
      token:API_TOKEN,
      action:editingScanId?"UPDATE_SCAN":"CREATE_SCAN",
      scan_id:editingScanId||"",
      client:{operator:operatorEl.value},
      scan:{
        code_value:noEanFlag?"":scanEl.value,
        no_ean:noEanFlag
      },
      product:{
        product_reference:document.getElementById("reference").value,
        quantity:Number(document.getElementById("quantity").value),
        color:document.getElementById("color").value,
        comment:document.getElementById("comment").value
      },
      images:{items:images.map(i=>({index:i.index,data_base64:i.data,mime:"image/jpeg"}))}
    })
  }).then(()=>{toast("EnregistrÃ© âœ”");resetForm();});
}
function resetForm(){
  scanEl.value="";
  document.getElementById("reference").value="";
  document.getElementById("quantity").value="";
  document.getElementById("color").value="";
  document.getElementById("comment").value="";
  images=[];noEanFlag=false;renderPreviews();focusScan();
}

focusScan();
</script>

</body>
</html>
