<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanbar.appV2</title>
<style>
  body { font-family: system-ui, Arial; margin: 12px; }
  h2 { margin-top: 0; }
  label { font-weight: 600; display:block; margin-top:10px; }
  input, select, textarea, button { width:100%; padding:10px; margin-top:5px; font-size:16px; }
  button { cursor:pointer; }
  .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin-bottom:12px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row > button { flex:1; min-width: 160px; }
  img.preview { max-width:100px; border:1px solid #ccc; border-radius:6px; margin:5px; }
  .muted { color:#666; font-size:13px; }
  .ok { color:green; }
  .err { color:red; }
  .item { padding:8px; border:1px solid #eee; border-radius:8px; margin:6px 0; }
  .item b { font-size: 15px; }
</style>
</head>

<body>

<h2>ðŸ“¦ Scanbar.appV2</h2>

<div class="card">
  <label>OpÃ©rateur *</label>
  <select id="operator">
    <option value="">â€” SÃ©lectionner â€”</option>
    <option>Alice</option>
    <option>Bob</option>
    <option>Charlie</option>
  </select>
  <div class="muted">Choisi une seule fois par session</div>
</div>

<div class="card">
  <div class="row" style="align-items:center;">
    <button type="button" onclick="toggleHistory()">ðŸ“œ Scans rÃ©cents</button>
    <span id="historyArrow" style="font-size:18px; margin-left:6px;">â–¶</span>
    <button type="button" onclick="clearEdit()" style="margin-left:auto;">âž• Nouveau scan</button>
  </div>

  <div id="historyPanel" style="display:none; margin-top:10px;">

    <div class="row">
      <input id="filterRef" placeholder="Filtrer par rÃ©fÃ©rence" oninput="applyFilters()">
      <input id="filterCode" placeholder="Filtrer par code" oninput="applyFilters()">
    </div>

    <div class="row">
      <button type="button" onclick="loadRecent()">ðŸ”„ Actualiser</button>
      <button type="button" onclick="exportCSV()">â¬‡ Export CSV</button>
    </div>

    <div id="recentList"
         style="margin-top:10px; max-height:260px; overflow-y:auto;">
    </div>

  </div>
</div>

<script>
/* =========================
   HISTORIQUE / FILTRES / CSV
   ========================= */

let recentItemsCache = [];
let historyOpen = false;

function toggleHistory() {
  historyOpen = !historyOpen;
  document.getElementById("historyPanel").style.display = historyOpen ? "block" : "none";
  document.getElementById("historyArrow").textContent = historyOpen ? "â–¼" : "â–¶";

  if (historyOpen && !recentItemsCache.length) {
    loadRecent();
  }
}

function loadRecent() {
  const operator = operatorEl.value.trim();
  if (!operator) return setStatus("SÃ©lectionne l'opÃ©rateur d'abord", "err");

  setStatus("Chargement scans rÃ©centsâ€¦");

  const payload = {
    version: 1,
    token: API_TOKEN,
    action: "LIST_RECENT",
    client: { operator, device: navigator.userAgent },
    limit: 50
  };

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(r => {
    if (!r.ok) throw new Error(r.error || "Erreur");
    recentItemsCache = r.items || [];
    applyFilters();
    setStatus("OK", "ok");
  })
  .catch(e => setStatus(e.message, "err"));
}

function applyFilters() {
  const ref = document.getElementById("filterRef").value.toLowerCase();
  const code = document.getElementById("filterCode").value.toLowerCase();

  const filtered = recentItemsCache.filter(it => {
    const r = String(it.product_reference || "").toLowerCase();
    const c = String(it.code_value || "").toLowerCase();
    return (!ref || r.includes(ref)) && (!code || c.includes(code));
  });

  renderRecent(filtered);
}

function renderRecent(items) {
  const div = document.getElementById("recentList");

  if (!items.length) {
    div.innerHTML = "<div class='muted'>Aucun scan rÃ©cent.</div>";
    return;
  }

  div.innerHTML = items.slice(0, 50).map(it => {
    const ts = it.scan_timestamp || "";
    const ref = it.product_reference || "";
    const qty = it.quantity || "";
    const code = it.code_value || "";
    const hasImg = (it.image_1_url_raw || it.image_2_url_raw || it.image_3_url_raw) ? "ðŸ“·" : "";

    return `
      <div class="item">
        <div><b>${ref}</b> Â· QtÃ© ${qty} ${hasImg}</div>
        <div class="muted">${ts} Â· ${code}</div>
        <button type="button" style="margin-top:6px;"
          onclick='selectRecent(${JSON.stringify(it)})'>Ouvrir</button>
      </div>
    `;
  }).join("");
}

function exportCSV() {
  if (!recentItemsCache.length) {
    return setStatus("Aucune donnÃ©e Ã  exporter", "err");
  }

  const headers = [
    "scan_timestamp",
    "operator",
    "code_type",
    "code_value",
    "product_reference",
    "quantity",
    "color",
    "comment",
    "image_folder_url"
  ];

  const rows = recentItemsCache.map(it =>
    headers.map(h =>
      `"${String(it[h] || "").replace(/"/g, '""')}"`
    ).join(";")
  );

  const csv = headers.join(";") + "\n" + rows.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "scanbar_export.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
