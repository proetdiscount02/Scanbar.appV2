<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanbar.appV2</title>

<style>
  body { font-family: system-ui, Arial; margin: 12px; background:#f7f7f7; }
  h2 { margin: 0 0 10px 0; }
  label { font-weight: 600; display:block; margin-top:10px; }
  input, select, textarea, button {
    width:100%; padding:10px; margin-top:5px; font-size:16px;
    box-sizing:border-box;
  }
  button { cursor:pointer; }
  button[disabled] { opacity:0.55; cursor:not-allowed; }

  .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:12px; margin-bottom:12px; }

  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > * { flex:1; min-width: 140px; }

  .muted { color:#666; font-size:13px; }
  .ok { color:#2e7d32; }
  .err { color:#c62828; }

  img.preview { max-width:100px; border:1px solid #ccc; border-radius:6px; margin:5px; }

  .item { padding:8px; border:1px solid #eee; border-radius:8px; margin:6px 0; }
  .item b { font-size: 15px; }

  .chip { display:inline-block; padding:2px 10px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#444; background:#fff; }
  .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }

  .toast {
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background:#222; color:#fff; padding:10px 14px; border-radius:10px;
    opacity:0; transition:opacity .2s; pointer-events:none; max-width:92vw;
  }
  .toast.show { opacity:0.95; }

  .overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.25);
    display:none; align-items:center; justify-content:center; z-index:9999;
  }
  .overlay .box {
    background:#fff; border-radius:12px; padding:16px 18px; border:1px solid #ddd;
    display:flex; gap:12px; align-items:center; width:min(420px, 92vw);
  }
  .spinner {
    width:18px; height:18px; border:3px solid #ddd; border-top-color:#333; border-radius:50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<div class="topbar">
  <h2 style="margin:0;">ðŸ“¦ Scanbar.appV2</h2>
  <span id="modeChip" class="chip">Mode: Nouveau</span>
</div>

<!-- OPERATEUR -->
<div class="card">
  <label>OpÃ©rateur *</label>
  <select id="operator">
    <option value="">â€” SÃ©lectionner â€”</option>
    <option>Anthony</option>
    <option>Johan</option>
    <option>KÃ©o</option>
    <option>Michael</option>
  </select>
  <div class="muted">Choisi une seule fois par session</div>
</div>

<!-- HISTORIQUE -->
<div class="card">
  <div class="row" style="align-items:center;">
    <button id="btnToggleHistory" type="button" onclick="toggleHistory()">ðŸ“œ Scans rÃ©cents</button>
    <span id="historyArrow" style="flex:0 0 auto;">â–¶</span>
    <button id="btnNewScan" type="button" onclick="clearEdit()">âž• Nouveau scan</button>
  </div>

  <div id="historyPanel" style="display:none;margin-top:10px;">
    <div class="row">
      <input id="filterRef" placeholder="Filtrer par rÃ©fÃ©rence" oninput="applyFilters()">
      <input id="filterCode" placeholder="Filtrer par code" oninput="applyFilters()">
    </div>

    <div class="row">
      <label style="margin:0; font-weight:600; display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="filterNoPhoto" onchange="applyFilters()" style="width:auto; margin:0;">
        Sans photo
      </label>
      <label style="margin:0; font-weight:600; display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="filterToday" onchange="applyFilters()" style="width:auto; margin:0;">
        Aujourdâ€™hui
      </label>
    </div>

    <div class="row">
      <button id="btnRefresh" type="button" onclick="loadRecent()">ðŸ”„ Actualiser</button>
      <button id="btnExport" type="button" onclick="exportCSV()">â¬‡ Export CSV (filtrÃ©)</button>
    </div>

    <div id="recentList" style="max-height:260px; overflow-y:auto; margin-top:10px;"></div>
  </div>
</div>

<!-- SCAN -->
<div class="card">
  <label>Code EAN / QR</label>
  <input id="scanInput" placeholder="Scanner ici (douchette)" autocomplete="off">
  <div class="row">
    <button type="button" onclick="startCameraScan()">ðŸ“· Scanner avec lâ€™appareil photo</button>
    <button type="button" onclick="noEAN()">Produit sans EAN</button>
    <button type="button" onclick="clearScan()">Effacer</button>
  </div>
  <div class="muted">Astuce : aprÃ¨s scan, appuie sur EntrÃ©e â†’ focus RÃ©fÃ©rence</div>
</div>

<!-- PRODUIT -->
<div class="card">
  <label>RÃ©fÃ©rence produit *</label>
  <input id="reference" autocomplete="off">

  <label>QuantitÃ© *</label>
  <input id="quantity" type="number" min="1" autocomplete="off">

  <label>Poids (optionnel)</label>
  <input id="weight" placeholder="ex: 1200g ou 1.2kg" autocomplete="off">

  <label>Emplacement (optionnel)</label>
  <input id="location" placeholder="ex: A3-12 / RACK 4" autocomplete="off">

  <label>Dimensions (optionnel)</label>
  <input id="dimension" placeholder="ex: 30x20x10" autocomplete="off">

  <label>Couleur (optionnel)</label>
  <input id="color" autocomplete="off">

  <label>Commentaire (optionnel)</label>
  <textarea id="comment"></textarea>
</div>

<!-- PHOTOS -->
<div class="card">
  <label>Photos (max 3)</label>
  <input id="photoInput" type="file" accept="image/*" capture="environment" onchange="addImage(this)">
  <div id="previews"></div>
  <div class="muted">Photos compressÃ©es automatiquement (500Ã—500)</div>
</div>

<!-- ACTION -->
<div class="card">
  <button id="btnSubmit" type="button" onclick="submitScan()">âœ… Valider le scan</button>
  <div id="status" class="muted" style="margin-top:8px;"></div>
</div>

<!-- overlay envoi -->
<div id="overlay" class="overlay">
  <div class="box">
    <div class="spinner"></div>
    <div>
      <div style="font-weight:700;">Envoi en coursâ€¦</div>
      <div class="muted">Ne ferme pas la page</div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/************ CONFIG ************/
const API_URL = "COLLE_ICI_TON_URL_WEBAPP_EXEC";
const API_TOKEN = "COLLE_ICI_TON_TOKEN";

/************ STATE ************/
let images = [];
let noEanFlag = false;
let editingScanId = null;

let recentItemsCache = [];
let recentItemsFiltered = [];
let historyOpen = false;

let isSending = false;

/************ ELEMENTS ************/
const operatorEl = document.getElementById("operator");
const scanEl = document.getElementById("scanInput");
const refEl = document.getElementById("reference");
const qtyEl = document.getElementById("quantity");
const btnSubmit = document.getElementById("btnSubmit");
const modeChip = document.getElementById("modeChip");
const overlay = document.getElementById("overlay");

/************ SESSION ************/
operatorEl.value = localStorage.getItem("scanba_operator") || "";
operatorEl.onchange = () => localStorage.setItem("scanba_operator", operatorEl.value);

/************ UX ************/
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1200);
}
function setStatus(msg, cls="muted") {
  const s = document.getElementById("status");
  s.textContent = msg;
  s.className = cls;
}
function setMode(mode) { modeChip.textContent = "Mode: " + mode; }
function focusScan(){ setTimeout(() => scanEl.focus(), 50); }
function focusRef(){ setTimeout(() => refEl.focus(), 50); }
function focusQty(){ setTimeout(() => qtyEl.focus(), 50); }
function focusSubmit(){ setTimeout(() => btnSubmit.focus(), 50); }

function setSending(on){
  isSending = on;
  overlay.style.display = on ? "flex" : "none";
  btnSubmit.disabled = on;
  document.getElementById("btnToggleHistory").disabled = on;
  document.getElementById("btnNewScan").disabled = on;
}

/************ WORKFLOW FOCUS (EntrÃ©e) ************/
scanEl.addEventListener("keydown", e => {
  if (e.key === "Enter") { e.preventDefault(); focusRef(); }
});

refEl.addEventListener("keydown", e => {
  if (e.key === "Enter") { e.preventDefault(); focusQty(); }
});

qtyEl.addEventListener("keydown", e => {
  if (e.key === "Enter") { e.preventDefault(); focusSubmit(); }
});

/************ SCAN ************/
function noEAN(){
  noEanFlag = true;
  scanEl.value = "";
  toast("Sans EAN");
  setStatus("Produit sans EAN (code interne gÃ©nÃ©rÃ©)", "ok");
  focusRef(); // logique: sans EAN -> on passe Ã  la rÃ©fÃ©rence
}
function clearScan(){
  noEanFlag = false;
  scanEl.value = "";
  focusScan();
}

/************ CAMERA SCAN ************/
let camStream = null, detector = null;

async function startCameraScan() {
  if (!("BarcodeDetector" in window)) {
    alert("Scan camÃ©ra non supportÃ© sur ce navigateur.\nUtilise la douchette.");
    return;
  }
  try {
    detector = new BarcodeDetector({ formats: ["ean_13","ean_8","qr_code"] });

    const video = document.createElement("video");
    video.setAttribute("playsinline", true);
    video.style.width = "100%";
    video.style.borderRadius = "10px";

    const box = document.createElement("div");
    box.className = "card";
    box.appendChild(video);

    const btn = document.createElement("button");
    btn.type = "button";
    btn.textContent = "âœ– Fermer la camÃ©ra";
    btn.onclick = () => stopCamera(box);
    box.appendChild(btn);

    document.body.prepend(box);

    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = camStream;
    await video.play();

    (function loop(){
      detector.detect(video).then(codes => {
        if (codes.length) {
          scanEl.value = codes[0].rawValue;
          toast("Code dÃ©tectÃ© âœ”");
          stopCamera(box);
          focusRef(); // IMPORTANT: aprÃ¨s camÃ©ra -> focus rÃ©fÃ©rence
        } else requestAnimationFrame(loop);
      }).catch(() => requestAnimationFrame(loop));
    })();

  } catch (e) {
    alert("Impossible d'accÃ©der Ã  la camÃ©ra.");
  }
}
function stopCamera(box){
  if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
  if (box) box.remove();
}

/************ IMAGES ************/
function addImage(input) {
  if (!input.files[0]) return;
  if (images.length >= 3) return setStatus("Max 3 photos", "err");

  const file = input.files[0];
  resizeImage(file, 500, data => {
    images.push({ index: images.length + 1, data });
    renderPreviews();
    toast("Photo ajoutÃ©e");
  });
  input.value = "";
}

function resizeImage(file, max, cb) {
  const img = new Image();
  const reader = new FileReader();
  reader.onload = e => {
    img.onload = () => {
      const scale = Math.min(max / img.width, max / img.height, 1);
      const canvas = document.createElement("canvas");
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
      cb(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function renderPreviews() {
  const div = document.getElementById("previews");
  div.innerHTML = "";
  images.forEach(i => {
    const im = document.createElement("img");
    im.src = "data:image/jpeg;base64," + i.data;
    im.className = "preview";
    div.appendChild(im);
  });
}

/************ HISTORY ************/
function toggleHistory(){
  historyOpen = !historyOpen;
  document.getElementById("historyPanel").style.display = historyOpen ? "block" : "none";
  document.getElementById("historyArrow").textContent = historyOpen ? "â–¼" : "â–¶";
  if (historyOpen && !recentItemsCache.length) loadRecent();
}

function loadRecent(){
  const operator = operatorEl.value.trim();
  if (!operator) return setStatus("SÃ©lectionne l'opÃ©rateur d'abord", "err");

  setStatus("Chargement scans rÃ©centsâ€¦");

  const payload = {
    token: API_TOKEN,
    action: "LIST_RECENT",
    client: { operator, device: navigator.userAgent },
    limit: 120
  };

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(r => {
    if (!r.ok) throw new Error(r.error || "Erreur");
    recentItemsCache = r.items || [];
    applyFilters();
    setStatus("OK", "ok");
  })
  .catch(e => setStatus(e.message, "err"));
}

function isToday_(val){
  if (!val) return false;
  const d = new Date(val);
  if (isNaN(d.getTime())) return false;
  const now = new Date();
  return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
}

function applyFilters(){
  const ref = (document.getElementById("filterRef").value || "").toLowerCase();
  const code = (document.getElementById("filterCode").value || "").toLowerCase();
  const noPhoto = !!document.getElementById("filterNoPhoto").checked;
  const today = !!document.getElementById("filterToday").checked;

  const filtered = recentItemsCache.filter(it => {
    const r = String(it.product_reference || "").toLowerCase();
    const c = String(it.code_value || "").toLowerCase();
    const hasImg = !!(it.image_1_url_raw || it.image_2_url_raw || it.image_3_url_raw);
    return (!ref || r.includes(ref)) &&
           (!code || c.includes(code)) &&
           (!noPhoto || !hasImg) &&
           (!today || isToday_(it.scan_timestamp));
  });

  recentItemsFiltered = filtered;
  renderRecent(filtered);
}

function renderRecent(items){
  const div = document.getElementById("recentList");
  if (!items.length) {
    div.innerHTML = "<div class='muted'>Aucun scan.</div>";
    return;
  }

  div.innerHTML = items.slice(0, 120).map(it => {
    const ts = it.scan_timestamp ? String(it.scan_timestamp) : "";
    const code = it.code_value ? String(it.code_value) : "";
    const ref = it.product_reference ? String(it.product_reference) : "";
    const qty = it.quantity ? String(it.quantity) : "";
    const hasImg = (it.image_1_url_raw || it.image_2_url_raw || it.image_3_url_raw) ? "ðŸ“·" : "";

    // IMPORTANT: bouton Ouvrir -> mode Ã©dition (prÃ©remplissage)
    return `
      <div class="item">
        <div><b>${ref}</b> Â· QtÃ© ${qty} ${hasImg}</div>
        <div class="muted">${ts} Â· ${code}</div>
        <button type="button" style="margin-top:6px;" onclick='selectRecent(${JSON.stringify(it)})'>Ouvrir / Ã©diter</button>
      </div>
    `;
  }).join("");
}

/************ EDIT MODE ************/
function selectRecent(item){
  editingScanId = item.scan_id;

  scanEl.value = item.code_value || "";
  document.getElementById("reference").value = item.product_reference || "";
  document.getElementById("quantity").value = item.quantity || "";

  // nouveaux champs
  document.getElementById("weight").value = item.weight || "";
  document.getElementById("location").value = item.location || "";
  document.getElementById("dimension").value = item.dimension || "";

  document.getElementById("color").value = item.color || "";
  document.getElementById("comment").value = item.comment || "";

  images = [];              // on laisse les anciennes photos cÃ´tÃ© sheet, ici on repart Ã  vide
  noEanFlag = (String(item.code_type || "").toUpperCase() === "INTERNAL");
  renderPreviews();

  btnSubmit.textContent = "ðŸ’¾ Mettre Ã  jour";
  setMode("Ã‰dition");
  setStatus("Mode Ã©dition : modifie puis clique Mettre Ã  jour", "ok");
  toast("Ã‰dition");
  focusRef();
}

function clearEdit(){
  editingScanId = null;
  btnSubmit.textContent = "âœ… Valider le scan";
  setMode("Nouveau");
  resetForm();
  setStatus("Mode nouveau scan", "muted");
  toast("Nouveau scan");
}

/************ EXPORT CSV ************/
function exportCSV(){
  const data = recentItemsFiltered.length ? recentItemsFiltered : recentItemsCache;
  if (!data.length) return setStatus("Aucune donnÃ©e Ã  exporter", "err");

  const headers = [
    "scan_timestamp",
    "operator",
    "code_type",
    "code_value",
    "product_reference",
    "quantity",
    "weight",
    "location",
    "dimension",
    "color",
    "comment",
    "image_folder_url"
  ];

  const rows = data.map(it =>
    headers.map(h => `"${String(it[h] || "").replace(/"/g, '""')}"`).join(";")
  );

  const csv = headers.join(";") + "\n" + rows.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "scanbar_export.csv";
  a.click();

  URL.revokeObjectURL(url);
  toast("CSV exportÃ©");
}

/************ SUBMIT ************/
function submitScan(){
  if (isSending) return;

  const operator = operatorEl.value.trim();
  const reference = document.getElementById("reference").value.trim();
  const quantity = Number(document.getElementById("quantity").value);

  if (!operator) return toast("Choisis l'opÃ©rateur");
  if (!reference || !Number.isFinite(quantity) || quantity < 1) {
    setStatus("RÃ©fÃ©rence + quantitÃ© obligatoires (>=1)", "err");
    toast("Champs manquants");
    return;
  }

  const payload = {
    token: API_TOKEN,
    action: editingScanId ? "UPDATE_SCAN" : "CREATE_SCAN",
    scan_id: editingScanId || "",
    client: { operator, device: navigator.userAgent },
    scan: {
      scan_method: "scanner",
      code_value: noEanFlag ? "" : scanEl.value.trim(),
      no_ean: noEanFlag
    },
    product: {
      product_reference: reference,
      quantity: quantity,
      weight: document.getElementById("weight").value.trim(),
      location: document.getElementById("location").value.trim(),
      dimension: document.getElementById("dimension").value.trim(),
      color: document.getElementById("color").value.trim(),
      comment: document.getElementById("comment").value.trim()
    },
    images: {
      items: images.map(i => ({
        index: i.index,
        filename: `IMG_${i.index}.jpg`,
        mime: "image/jpeg",
        data_base64: i.data
      }))
    }
  };

  setSending(true);
  setStatus(editingScanId ? "Mise Ã  jourâ€¦" : "Envoiâ€¦");

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(r => {
    if (!r.ok) throw new Error(r.error || "Erreur");

    // succÃ¨s
    editingScanId = null;
    btnSubmit.textContent = "âœ… Valider le scan";
    setMode("Nouveau");
    resetForm();
    setStatus("OK âœ”", "ok");
    toast("EnregistrÃ© âœ”");

    if (historyOpen) loadRecent();
  })
  .catch(e => {
    setStatus(e.message, "err");
    toast("Erreur");
  })
  .finally(() => {
    setSending(false);
    focusScan();
  });
}

/************ RESET ************/
function resetForm(){
  scanEl.value = "";
  document.getElementById("reference").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("weight").value = "";
  document.getElementById("location").value = "";
  document.getElementById("dimension").value = "";
  document.getElementById("color").value = "";
  document.getElementById("comment").value = "";
  images = [];
  noEanFlag = false;
  renderPreviews();
  focusScan();
}

// Init
setMode("Nouveau");
focusScan();
</script>

</body>
</html>
