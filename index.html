<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Scanbar.appV2</title>

  <style>
    .headerBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 10px 0 16px;
}

.appBadge{
  background: var(--blue);
  color:#fff;
  font-weight: 900;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1;
  white-space: nowrap;
  box-shadow: 0 2px 0 rgba(0,0,0,.08);
}

.appBadgeGhost{
  visibility:hidden;
}

.brandCenter{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}

.brandCenter img{
  max-height: 62px;
  width:auto;
  display:block;
}
    .topbar{
  height:6px;
  background: var(--blue);
  border-bottom: 1px solid var(--border);
}
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e6e6e6;
      --text:#111827;
      --muted:#6b7280;

      --blue:#1f5aa6;
      --blueHover:#184b8a;

      --red:#d7262e;
      --redHover:#b91d24;

      --shadow:0 6px 20px rgba(0,0,0,.06);
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 980px;
      margin: 16px auto 40px;
      padding: 0 14px;
    }

    /* HEADER */
    .brand{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 10px 0 16px;
    }
    .brand img{
      max-height: 62px;
      width:auto;
      display:block;
    }

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      margin:14px 0;
    }
    label{
      display:block;
      font-weight:700;
      margin: 10px 0 6px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    input, select, textarea{
      width:100%;
      font-size:16px;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
    }
    textarea{min-height: 92px; resize: vertical;}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{flex:1 1 260px;}

    /* BUTTONS */
    .btn{
      appearance:none;
      border:none;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight:800;
      cursor:pointer;
      background: var(--blue);
      color:#fff;
      transition: .12s ease-in-out;
      box-shadow: 0 2px 0 rgba(0,0,0,.08);
      user-select:none;
    }
    .btn:hover{ background: var(--blueHover); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btnDanger{ background: var(--red); }
    .btnDanger:hover{ background: var(--redHover); }

    .btnGhost{
      background:#f3f4f6;
      color:#111827;
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btnGhost:hover{ background:#eceff3; }

    /* STATUS + LOADER */
    .status{ margin-top: 10px; font-weight:700; font-size: 14px; }
    .ok{color:#0f766e}
    .err{color:#b91c1c}
    .muted{color:var(--muted)}

    .loadingBar{
      display:none;
      margin-top:10px;
      height:8px;
      border-radius:999px;
      background:#eef2ff;
      overflow:hidden;
      border:1px solid #e5e7eb;
    }
    .loadingBar > div{
      width:40%;
      height:100%;
      border-radius:999px;
      background:var(--blue);
      animation: move 1.1s infinite linear;
    }
    @keyframes move{
      0%{transform:translateX(-120%)}
      100%{transform:translateX(260%)}
    }

    /* HISTORY DRAWER */
    .drawerHead{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .arrow{
      width:38px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:18px;
      cursor:pointer;
      user-select:none;
    }
    #historyPanel{ display:none; margin-top:10px; }
    #recentList{
      margin-top:10px;
      max-height: 320px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
    }
    .item{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .item:last-child{margin-bottom:0}
    .small{font-size:12px;color:var(--muted)}

    /* PHOTO PREVIEWS */
    .previews{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .preview{
      width: 100px;
      height: 100px;
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
      background:#fafafa;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .preview img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .preview .x{
      position:absolute;
      top:6px;
      right:6px;
      width:22px;
      height:22px;
      border-radius:50%;
      border:none;
      cursor:pointer;
      background:rgba(0,0,0,.55);
      color:#fff;
      font-weight:900;
      line-height:22px;
    }

    /* CAMERA PANEL */
    #camPanel{display:none; margin-top:10px;}
    #camVideo{
      width:100%;
      max-height: 360px;
      background:#000;
      border-radius: 12px;
      border:1px solid var(--border);
    }
    .camHint{font-size:12px;color:var(--muted); margin-top:8px;}

    @media (max-width:520px){
      .brand img{ max-height:52px; }
      .btn{ width:100%; }
      .row > *{ flex:1 1 100%; }
      .drawerHead{flex-wrap:wrap;}
      .arrow{width:100%; height:42px;}
    }
  </style>
</head>

<body>
  
   <div class="topbar"></div>
  
  <div class="wrap">

    <!-- LOGO -->
    <div class="headerBar">
  <div class="appBadge">Scanbar.appV2</div>

  <div class="brandCenter">
    <img src="logo.png?v=2" alt="promosdiscount">
  </div>

  <div class="appBadge appBadgeGhost">Scanbar.appV2</div>
</div>

    <!-- OPERATEUR -->
    <div class="card">
      <label>Op√©rateur *</label>
      <select id="operator">
        <option value="">‚Äî S√©lectionner ‚Äî</option>
        <option>Anthony</option>
        <option>Johan</option>
        <option>K√©o</option>
        <option>Michael</option>
      </select>
      <div class="hint">Choisi une seule fois par session</div>
    </div>

    <!-- HISTORY -->
    <div class="card">
      <div class="drawerHead">
        <button class="btn" type="button" onclick="toggleHistory()">üìú Scans r√©cents</button>
        <div class="arrow" id="historyArrow" onclick="toggleHistory()">‚ñ∂</div>
        <button class="btnGhost" type="button" onclick="clearEdit()">‚ûï Nouveau scan</button>
      </div>

      <div id="historyPanel">
        <div class="row">
          <input id="filterRef" placeholder="Filtrer par r√©f√©rence" oninput="applyFilters()">
          <input id="filterCode" placeholder="Filtrer par code" oninput="applyFilters()">
        </div>
        <div class="row">
          <button class="btn" type="button" onclick="loadRecent()">üîÑ Actualiser</button>
          <button class="btn" type="button" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>
        <div id="recentList" class="muted">Clique ‚ÄúScans r√©cents‚Äù pour charger‚Ä¶</div>
      </div>
    </div>

    <!-- SCAN -->
    <div class="card">
      <label>Scan EAN / QR</label>
      <input id="scanInput" placeholder="Scanner ici (douchette)">

      <div class="row" style="margin-top:10px;">
        <button class="btn" type="button" onclick="toggleCamera()">üì∑ Scanner cam√©ra</button>
        <button class="btn" type="button" onclick="noEan()">Produit sans EAN</button>
        <button class="btnGhost" type="button" onclick="resetForm()">Effacer</button>
      </div>

      <!-- CAMERA -->
      <div id="camPanel">
        <video id="camVideo" playsinline></video>
        <div class="row" style="margin-top:10px;">
          <button class="btnGhost" type="button" onclick="stopCamera()">‚èπ Stop cam√©ra</button>
        </div>
        <div class="camHint" id="camHint">Autorise la cam√©ra. Si ton navigateur ne supporte pas BarcodeDetector, ZXing sera charg√© automatiquement.</div>
      </div>

      <div class="hint">Mode rafale : focus auto sur le scan apr√®s validation.</div>
    </div>

    <!-- PRODUIT -->
    <div class="card">
      <label>R√©f√©rence produit *</label>
      <input id="reference">

      <label>Quantit√© *</label>
      <input id="quantity" type="number" min="1">

      <label>Poids (optionnel)</label>
      <input id="weight">

      <label>Emplacement (optionnel)</label>
      <input id="location">

      <label>Dimensions (optionnel)</label>
      <input id="dimension">

      <label>Couleur (optionnel)</label>
      <input id="color">

      <label>Commentaire (optionnel)</label>
      <textarea id="comment"></textarea>
    </div>

    <!-- PHOTOS -->
    <div class="card">
      <label>Photos (max 3)</label>
      <input id="photoInput" type="file" accept="image/*" capture="environment" multiple>
      <div class="hint">Jusqu‚Äô√† 3 photos. Compression auto (500√ó500 max).</div>
      <div class="previews" id="previews"></div>
    </div>

    <!-- SUBMIT -->
    <div class="card">
      <button id="btnSubmit" class="btn btnDanger" type="button" onclick="submitScan()">‚úÖ Valider le scan</button>
      <div class="loadingBar" id="loadingBar"><div></div></div>
      <div class="status muted" id="status">Pr√™t.</div>
    </div>

  </div>

<script>
  /******************** CONFIG (CHANGE ONLY THESE 2) ********************/
  const API_URL = "https://script.google.com/macros/s/AKfycbyh1-hHVbFG-at9GDAU40q8dqxYkSYLqbO1bLntrIRZVWz7uDwYZcccktSnICFjZBvN/exec";
  const API_TOKEN = "PRO_DISCOUNT02";
  /************************************************************************/

  const operatorEl = document.getElementById("operator");
  const scanEl = document.getElementById("scanInput");
  const refEl = document.getElementById("reference");
  const qtyEl = document.getElementById("quantity");
  const weightEl = document.getElementById("weight");
  const locationEl = document.getElementById("location");
  const dimEl = document.getElementById("dimension");
  const colorEl = document.getElementById("color");
  const commentEl = document.getElementById("comment");
  const photoEl = document.getElementById("photoInput");
  const previewsEl = document.getElementById("previews");
  const statusEl = document.getElementById("status");
  const loadingBar = document.getElementById("loadingBar");
  const btnSubmit = document.getElementById("btnSubmit");

  const camPanel = document.getElementById("camPanel");
  const camVideo = document.getElementById("camVideo");
  const camHint = document.getElementById("camHint");

  let images = [];              // {data_base64, mime, index}
  let noEanFlag = false;
  let editingScanId = null;

  let recentItemsCache = [];
  let historyOpen = false;

  // scan_method guidance
  let lastScanMethod = "scanner"; // scanner | phone | manual

  // Camera
  let camStream = null;
  let camTimer = null;
  let barcodeDetector = null;
  let zxingReader = null;
  let zxingLoaded = false;

  // Persist operator per session (localStorage)
  const OP_KEY = "scanbar_operator";
  operatorEl.addEventListener("change", () => {
    const v = operatorEl.value.trim();
    if (v) localStorage.setItem(OP_KEY, v);
  });

  window.addEventListener("load", () => {
    const saved = localStorage.getItem(OP_KEY) || "";
    if (saved) operatorEl.value = saved;
    setTimeout(() => scanEl.focus(), 150);
  });

  // Enter key workflow
  scanEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); lastScanMethod = "scanner"; refEl.focus(); }
  });
  refEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); qtyEl.focus(); }
  });
  qtyEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); btnSubmit.focus(); }
  });

  // If user types/pastes manually in scan field => scanner
  scanEl.addEventListener("input", () => { if (!noEanFlag) lastScanMethod = "scanner"; });

  function setStatus(msg, cls="muted"){
    statusEl.className = "status " + cls;
    statusEl.textContent = msg;
  }
  function setLoading(on){
    loadingBar.style.display = on ? "block" : "none";
    btnSubmit.disabled = !!on;
  }

  // Drawer
  function toggleHistory(){
    historyOpen = !historyOpen;
    document.getElementById("historyPanel").style.display = historyOpen ? "block" : "none";
    document.getElementById("historyArrow").textContent = historyOpen ? "‚ñº" : "‚ñ∂";
    if (historyOpen && !recentItemsCache.length) loadRecent();
  }

  function applyFilters(){
    const ref = (document.getElementById("filterRef").value || "").toLowerCase();
    const code = (document.getElementById("filterCode").value || "").toLowerCase();
    const filtered = recentItemsCache.filter(it => {
      const r = String(it.product_reference || "").toLowerCase();
      const c = String(it.code_value || "").toLowerCase();
      return (!ref || r.includes(ref)) && (!code || c.includes(code));
    });
    renderRecent(filtered);
  }

  function exportCSV(){
    if (!recentItemsCache.length) return setStatus("Aucune donn√©e √† exporter", "err");
    const headers = [
      "scan_timestamp","operator","scan_method","code_type","code_value",
      "product_reference","quantity","weight","location","dimension",
      "color","comment","image_folder_url","image_1_url_raw","image_2_url_raw","image_3_url_raw"
    ];
    const rows = recentItemsCache.map(it => headers.map(h => `"${String(it[h]||"").replace(/"/g,'""')}"`).join(";"));
    const csv = headers.join(";") + "\n" + rows.join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "scanbar_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // No EAN
  function noEan(){
    noEanFlag = true;
    lastScanMethod = "manual";
    scanEl.value = "";
    setStatus("Mode sans EAN : un code interne sera g√©n√©r√©", "ok");
    refEl.focus();
  }

  // Reset / clear edit
  function resetForm(){
    stopCamera();
    scanEl.value = "";
    refEl.value = "";
    qtyEl.value = "";
    weightEl.value = "";
    locationEl.value = "";
    dimEl.value = "";
    colorEl.value = "";
    commentEl.value = "";
    images = [];
    noEanFlag = false;
    lastScanMethod = "scanner";
    editingScanId = null;
    btnSubmit.textContent = "‚úÖ Valider le scan";
    photoEl.value = "";
    renderPreviews();
    setStatus("Pr√™t.", "muted");
    setTimeout(()=>scanEl.focus(), 50);
  }

  function clearEdit(){
    editingScanId = null;
    btnSubmit.textContent = "‚úÖ Valider le scan";
    resetForm();
    setStatus("Mode nouveau scan", "muted");
  }

  // Photos
  photoEl.addEventListener("change", async () => {
    const files = Array.from(photoEl.files || []).slice(0, 3);
    images = [];
    for (let i=0; i<files.length; i++){
      const b64 = await fileToBase64Compressed_(files[i], 500, 0.75);
      images.push({ index: i+1, data_base64: b64.base64, mime: b64.mime });
    }
    renderPreviews();
  });

  function renderPreviews(){
    previewsEl.innerHTML = "";
    if (!images.length) return;

    images.forEach((img, idx) => {
      const div = document.createElement("div");
      div.className = "preview";
      const im = document.createElement("img");
      im.src = `data:${img.mime};base64,${img.data_base64}`;
      const x = document.createElement("button");
      x.className = "x";
      x.textContent = "√ó";
      x.onclick = () => { images.splice(idx,1); renderPreviews(); };
      div.appendChild(im);
      div.appendChild(x);
      previewsEl.appendChild(div);
    });
  }

  // Payload
  function payloadBase(action){
    const scan_method = (images.length ? "phone" : lastScanMethod);
    return {
      version: 1,
      token: API_TOKEN,
      action,
      client: { operator: operatorEl.value.trim(), device: navigator.userAgent },
      scan: {
        scan_method,
        no_ean: !!noEanFlag,
        code_value: (scanEl.value || "").trim()
      },
      product: {
        product_reference: (refEl.value || "").trim(),
        quantity: Number(qtyEl.value || 0),
        weight: (weightEl.value || "").trim(),
        location: (locationEl.value || "").trim(),
        dimension: (dimEl.value || "").trim(),
        color: (colorEl.value || "").trim(),
        comment: (commentEl.value || "").trim()
      },
      images: { items: images }
    };
  }

  async function submitScan(){
    const operator = operatorEl.value.trim();
    if (!operator) return setStatus("S√©lectionne l'op√©rateur", "err");

    const ref = refEl.value.trim();
    const qty = Number(qtyEl.value || 0);
    if (!ref) return setStatus("R√©f√©rence obligatoire", "err");
    if (!qty || qty < 1) return setStatus("Quantit√© obligatoire (>=1)", "err");

    const action = editingScanId ? "UPDATE_SCAN" : "CREATE_SCAN";
    const payload = payloadBase(action);
    if (editingScanId) payload.scan_id = editingScanId;

    setLoading(true);
    setStatus("Envoi en cours‚Ä¶", "muted");

    try{
      const r = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || "Erreur");

      setStatus(editingScanId ? "‚úÖ Mise √† jour OK" : "‚úÖ Scan OK", "ok");

      // Keep operator; clear rest
      stopCamera();
      scanEl.value = "";
      refEl.value = "";
      qtyEl.value = "";
      weightEl.value = "";
      locationEl.value = "";
      dimEl.value = "";
      colorEl.value = "";
      commentEl.value = "";
      images = [];
      noEanFlag = false;
      lastScanMethod = "scanner";
      editingScanId = null;
      btnSubmit.textContent = "‚úÖ Valider le scan";
      photoEl.value = "";
      renderPreviews();

      setTimeout(()=>scanEl.focus(), 120);
      if (historyOpen) loadRecent();

    }catch(e){
      setStatus(String(e.message || e), "err");
    }finally{
      setLoading(false);
    }
  }

  // Recent list
  function loadRecent(){
    const operator = operatorEl.value.trim();
    if (!operator) return setStatus("S√©lectionne l'op√©rateur d'abord", "err");

    setStatus("Chargement scans r√©cents‚Ä¶", "muted");

    const payload = {
      version: 1,
      token: API_TOKEN,
      action: "LIST_RECENT",
      client: { operator, device: navigator.userAgent },
      limit: 120
    };

    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(j => {
      if (!j.ok) throw new Error(j.error || "Erreur");
      recentItemsCache = j.items || [];
      applyFilters();
      setStatus("OK", "ok");
    })
    .catch(e => setStatus(e.message, "err"));
  }

  function renderRecent(items){
    const div = document.getElementById("recentList");
    if (!items.length) {
      div.innerHTML = "<div class='muted'>Aucun scan r√©cent.</div>";
      return;
    }

    div.innerHTML = items.slice(0, 60).map(it => {
      const ts = it.scan_timestamp ? String(it.scan_timestamp) : "";
      const code = it.code_value ? String(it.code_value) : "";
      const ref = it.product_reference ? String(it.product_reference) : "";
      const qty = it.quantity ? String(it.quantity) : "";
      const hasImg = (it.image_1_url_raw || it.image_2_url_raw || it.image_3_url_raw) ? "üì∑" : "";
      return `
        <div class="item">
          <div><b>${escapeHtml_(ref)}</b> ¬∑ Qt√© ${escapeHtml_(qty)} ${hasImg}</div>
          <div class="small">${escapeHtml_(ts)} ¬∑ ${escapeHtml_(code)}</div>
          <button class="btn" type="button" style="margin-top:8px;" onclick='selectRecent(${JSON.stringify(it)})'>Ouvrir</button>
        </div>
      `;
    }).join("");
  }

  function selectRecent(item){
    editingScanId = item.scan_id;

    scanEl.value = item.code_value || "";
    refEl.value = item.product_reference || "";
    qtyEl.value = item.quantity || "";
    weightEl.value = item.weight || "";
    locationEl.value = item.location || "";
    dimEl.value = item.dimension || "";
    colorEl.value = item.color || "";
    commentEl.value = item.comment || "";

    images = [];
    noEanFlag = (String(item.code_type || "").toUpperCase() === "INTERNAL");
    lastScanMethod = String(item.scan_method || "scanner").toLowerCase() || "scanner";

    btnSubmit.textContent = "üíæ Mettre √† jour";
    setStatus("Mode √©dition : modifie + ajoute photos si besoin", "ok");

    setTimeout(()=>scanEl.focus(), 50);
  }

  // Camera scan (EAN / QR)
  async function toggleCamera(){
    if (camStream) return stopCamera();
    camPanel.style.display = "block";
    camHint.textContent = "D√©marrage cam√©ra‚Ä¶";
    try{
      lastScanMethod = "phone";
      camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
      camVideo.srcObject = camStream;
      await camVideo.play();

      // Prefer BarcodeDetector
      if ("BarcodeDetector" in window) {
        try{
          barcodeDetector = new BarcodeDetector({ formats: ["ean_13","ean_8","qr_code","code_128"] });
          camHint.textContent = "Cam√©ra OK ‚Äî d√©tection en cours (BarcodeDetector)‚Ä¶";
          startDetectLoop_BarcodeDetector_();
          return;
        } catch(e){
          barcodeDetector = null;
        }
      }

      // Fallback ZXing
      camHint.textContent = "BarcodeDetector indisponible ‚Äî chargement ZXing‚Ä¶";
      await loadZXing_();
      camHint.textContent = zxingLoaded ? "ZXing charg√© ‚Äî d√©tection en cours‚Ä¶" : "ZXing non charg√© (r√©seau/CDN). Utilise la douchette.";
      if (zxingLoaded) startDetectLoop_ZXing_();

    }catch(e){
      camHint.textContent = "Cam√©ra refus√©e / indisponible. Utilise la douchette.";
      stopCamera();
      setStatus(String(e.message || e), "err");
    }
  }

  function stopCamera(){
    if (camTimer){ clearInterval(camTimer); camTimer = null; }
    if (zxingReader){ try{ zxingReader.reset(); }catch(_){ } }
    barcodeDetector = null;

    if (camStream){
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
    camVideo.srcObject = null;
    camPanel.style.display = "none";
  }

  function startDetectLoop_BarcodeDetector_(){
    if (!barcodeDetector) return;
    if (camTimer) clearInterval(camTimer);

    camTimer = setInterval(async () => {
      try{
        const codes = await barcodeDetector.detect(camVideo);
        if (codes && codes.length){
          const val = String(codes[0].rawValue || "").trim();
          if (val){
            onDetectedCode_(val);
          }
        }
      }catch(_){}
    }, 250);
  }

  function startDetectLoop_ZXing_(){
    if (!zxingLoaded) return;
    if (camTimer) clearInterval(camTimer);

    try{
      zxingReader = new ZXing.BrowserMultiFormatReader();
      camTimer = setInterval(async () => {
        try{
          const result = await zxingReader.decodeOnceFromVideoElement(camVideo);
          if (result && result.text){
            onDetectedCode_(String(result.text).trim());
          }
        }catch(_){}
      }, 600);
    }catch(_){
      camHint.textContent = "ZXing error. Utilise la douchette.";
    }
  }

  function onDetectedCode_(val){
    stopCamera();
    scanEl.value = val;
    lastScanMethod = "phone";
    setStatus("Code d√©tect√© ‚úÖ", "ok");
    setTimeout(()=>refEl.focus(), 80);
  }

  function loadZXing_(){
    return new Promise((resolve) => {
      if (window.ZXing) { zxingLoaded = true; return resolve(); }
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js";
      s.onload = () => { zxingLoaded = !!window.ZXing; resolve(); };
      s.onerror = () => { zxingLoaded = false; resolve(); };
      document.head.appendChild(s);
    });
  }

  // Utils
  function escapeHtml_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Compression image => max 500px, qualit√© ~0.75
  function fileToBase64Compressed_(file, maxSize=500, quality=0.75){
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          const canvas = document.createElement("canvas");
          let w = img.width, h = img.height;
          const scale = Math.min(1, maxSize / Math.max(w,h));
          w = Math.round(w*scale); h = Math.round(h*scale);
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const mime = "image/jpeg";
          const dataUrl = canvas.toDataURL(mime, quality);
          const base64 = dataUrl.split(",")[1];
          resolve({ base64, mime });
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>

</body>
</html>
